<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>iCallate</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  </head>

  <body>
    <div class="container">
        <h1>iCallate</h1>
        <p class="lead">Allocate+ to iCalendar tool</p>
        <h2>Step 1</h2>
        <p>Log into <a href="https://allocate.timetable.monash.edu/aplus-2016/student">Allocate+</a>.</p>
        <h2>Step 2</h2>
        <pre>$(document.body).append('&lt;textarea style="width:100%;height:300px"&gt;'+JSON.stringify(data.student.allocated)+'&lt;/textarea&gt;');
$("#outer-container").hide();</pre>
        <p>
          Open up the JavaScript console. On most browsers, press <kbd>F12</kbd> and click on something which says "Console".
          Paste in the code above and <strong>DO NOT PRESS ENTER</strong>.
        </p>
        <p>
          Alternatively, go into the address bar, type in <code>javascript:</code>, and then paste in the code. <strong>DO NOT PRESS ENTER</strong>.
        </p>
        <h2>Step 3</h2>
        <p>
          Stare at the code that you just pasted in. Make sure it's the same code you copied. If you think it does something shifty, you should probably get away ASAP because it could do some pretty serious damage. If not, press <kbd>Enter</kbd>.
        </p>
        <h2>Step 4</h2>
        <p>
          A big bunch of text should appear at the top of your screen. Copy that and paste it in below:
          <div>
            <input type="text" placeholder="data.student.allocated" class="form-control" id="user-input">
          </div>
        </p>
        <h2>Step 5</h2>
        <p>
          Choose your options:
          <div class="checkbox">
            <label>
              <input type="checkbox" value="" id="clayton-addresses" checked>
              Monash Clayton: Use addresses (Room G15, 9 Rainforest Walk) instead of <a href="http://www.monash.edu/timetables/about/codes-abbreviations">location codes</a> (CL_9Rnf/G15)
            </label>
          </div>
        </p>
        <h2>Step 6</h2>
        <p>
          <button class="btn btn-default" id="generate-button"><span class="glyphicon glyphicon-calendar"></span> Generate <code>.ics</code></button>
        </p>
        <p>
          <a class="btn btn-default" id="download-button" style="visibility:hidden"><span class="glyphicon glyphicon-download"></span> Download <code>.ics</code></a>
        </p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
    <script>
      var claytonStreetNames = {
        All: "Alliance Lane",
        Anc: "Ancora Imparo Way",
        Chn: "Chancellors Walk",
        Col: "College Walk",
        Exh: "Exhibition Walk",
        FGR: "Ferntree Gully Road",
        Inn: "Innovation Walk",
        Rnf: "Rainforest Walk",
        Res: "Research Way",
        Sce: "Scenic Boulevard"
      };
      // http://stackoverflow.com/a/30832210
      function download(text, name, type) {
        var a = document.getElementById("download-button");
        var file = new Blob([text], {type: type});
        a.href = URL.createObjectURL(file);
        a.download = name;
        a.style.visibility = "visible";
      }

      function dayOfWeektoiCal(dayOfWeek) {
        return dayOfWeek.substr(0, 2).toUpperCase();
      }

      function momentToiCal(m) {
        return "TZID=Australia/Melbourne:" + m.format("YYYYMMDDTHHmmss");
      }

      function momentWeekIndexToIcal(m, index) {
        return momentToiCal(moment(m).week(index + 1));
      }

      function toVevent(obj) {
        var summary = `${obj.subject_code.substr(0, 7)} ${obj.activityType}`;
        var description = obj.description !== "-" ? obj.description : obj.subject_description;
        var location;
        var splitLocation = obj.location.split("/")
        if (document.getElementById("clayton-addresses").checked && splitLocation[0].startsWith("CL_") && claytonStreetNames.hasOwnProperty(splitLocation[0].substr(-3, 3))) {
          location = `Room ${splitLocation[1]}, ${splitLocation[0].slice(3, -3)} ${claytonStreetNames[splitLocation[0].substr(-3, 3)]}`;
        } else {
          location = obj.location;
        }

        var eventStartNoWeek = moment(obj.start_time, "HH:mm").day(obj.day_of_week);
        var eventEndNoWeek = moment(eventStartNoWeek).add(obj.duration, "minutes");

        var firstWeekIndex = obj.week_pattern.indexOf("1");
        var count = obj.week_pattern.lastIndexOf("1") - firstWeekIndex + 1;
        var excludeWeekIndices = [];
        // need to search from obj.week_pattern[firstWeekIndex + 1] to obj.week_pattern[firstWeekIndex + count - 2] inclusive for 0s
        for (var i = firstWeekIndex + 1; i < firstWeekIndex + count - 1; i++) {
          if (obj.week_pattern[i] === "0") {
            excludeWeekIndices.push(i);
          }
        }

        var dtStart = momentWeekIndexToIcal(eventStartNoWeek, firstWeekIndex);
        var dtEnd = momentWeekIndexToIcal(eventEndNoWeek, firstWeekIndex);

        var rRule = "FREQ=WEEKLY;COUNT=" + count + ";BYDAY=" + obj.day_of_week.substr(0, 2).toUpperCase();

        var exDateString = excludeWeekIndices.map(function (index) {
          return "EXDATE;" + momentWeekIndexToIcal(eventStartNoWeek, index);
        }).join("\n");

        return `BEGIN:VEVENT
DTSTART;${dtStart}
DTEND;${dtEnd}
RRULE:${rRule}
${exDateString}
DESCRIPTION:${description}
LOCATION:${location}
SUMMARY:${summary}
END:VEVENT`;
      }

      function generate() {
        var allocated;
        try {
          allocated = JSON.parse(document.getElementById("user-input").value);
        } catch (e) {
          alert("We got an error when parsing the input: " + e.toString());
        }
        var vEventString = Object.keys(allocated).map(function (key) {
          return toVevent(allocated[key]);
        }).join("\n");
        var icalendar = `BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
${vEventString}
END:VCALENDAR`
        download(icalendar, "allocateplus.ics", "text/calendar");
      }
      document.getElementById("generate-button").addEventListener("click", generate);
    </script>
  </body>
</html>
